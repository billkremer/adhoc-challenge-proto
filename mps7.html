<!DOCTYPE html>
<html>

<body>

  <h1>Ad Hoc Code Challenge:</h1>
  <h2>Proto: a MPS7 Decoder</h2>

  <label for="fileInput">Choose a file:</label>
  <br />
  <input id="fileInput" type="file"></input>
  <!-- <button onclick="encode()">Encode</button> -->
  <br />
  <button onclick="decode()">Decode</button>

  <p id="result"></p>

  <output id="list"></output>



  <!-- What is the total amount in dollars of debits?
What is the total amount in dollars of credits?
How many autopays were started?
How many autopays were ended?
What is balance of user ID 2456938384156277127? -->
  <script>
    var reader = new FileReader();
    var fileeo = '';
    var file = '';
  var temp = '';


    let decode = function () {
      file = document.getElementById("fileInput").files[0]; // FileList input
      console.log(file, typeof(file)); // File object.



      reader.onload = function () {
        console.log(reader.result);
           fileeo = reader.result;

          console.log(typeof(fileeo)); // string

//         console.log(fileeo.substring(0,4));
//         console.log(parseInt(fileeo.substring(4),2));

//         console.log(reader.readAsBinaryString);

//         var blob = file.slice(startingByte, endindByte);
//         reader.readAsBinaryString(blob);
//         reader.readAsArrayBuffer(fileeo);

//         console.log(reader.readAsArrayBuffer(fileeo));

//       temp = String.fromCharCode.apply(String, reader.readAsArrayBuffer(fileeo));

//         // create an ArrayBuffer with a size in bytes
//         var buffer = new ArrayBuffer(16);

//         var view = new DataView(buffer);
//         view.setUint32(1, 4294967295); // (max unsigned 32-bit integer)

//         console.log(view.getUint32(1));
// // expected output: 4294967295





console.log(fileeo.slice(0,4));


        test = new Uint8Array(fileeo.slice(0,4));
        // test = String.fromCharCode(test.toString());
        // test = test.toString();
        test = Array.from(test);
        var t = test.reduce(function (accumulator, currentValue, currentIndex, array) {
          return accumulator + String.fromCharCode(currentValue);
        }, '');
        // version = new Uint8Array(fileeo.slice(4,5))[0];
        var versionDV = new DataView(fileeo.slice(4, 5));
        var version = versionDV.getUint8(0);
        console.log(version);

          var numRecords = new DataView(fileeo.slice(5,9));
          var nn = numRecords.getUint32(0);

        // var nno = String.fromCharCode(00000071);
        // console.log(test,t, version, numRecords, nn, nno);


var offset = 9;
let records = [];
var start = offset;
// TODO buildup an array of objects
for (let i = 0; i <= nn; i++) { // check numrecords

  let recTypeDV = new DataView(fileeo.slice(start,start+1));
  let recType = recTypeDV.getUint8(0); // TODO: consider 'Debit' 'Credit', etc.
  start +=1;

  let timeStampDV = new DataView(fileeo.slice(start, start+4));
  let timeStamp = timeStampDV.getUint32(0);
  start +=4;

  let userIdDV = new DataView(fileeo.slice(start, start+8));
  let userId = userIdDV.getBigInt64(0).toString(10);

  // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays#Using_views_with_buffers


  // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays#Typed_array_views

  start +=8;

  // currentRec = fileeo.slice(start,end); // 13 bytes for each record, + 8 if debit or credit
  console.log('inloop', i, recType, timeStamp, userId);
 
  if (recType < 2) {
    let amountInDollarsDV = new DataView(fileeo.slice(start, start+8));
    let amountInDollars = amountInDollarsDV.getFloat64();

    console.log(amountInDollars);
    start +=8;
  }
  

}







      }
 console.log(fileeo,'as');

      console.log(reader.readAsArrayBuffer(file));


    }




  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
        f.size, ' bytes, last modified: ',
        f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
        '</li>');
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }

  document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);




  </script>

</body>

</html>